<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.movie.smallbox.dao.ReservationDao">
  
<insert id="insertReservation" parameterType="list">
	insert into reservation(userId, movieTitle, theaterName, scheduleTime, seatNumber)
	values
    <foreach collection="reservations" item="reservation" separator=",">
        (#{reservation.userId}, #{reservation.movieTitle}, #{reservation.theaterName}, #{reservation.scheduleTime}, #{reservation.seatNumbers[0]})
    </foreach>
</insert>

<select id="getReservation" parameterType="int" resultType="Reservation">
    SELECT MIN(reservationId) AS reservationId, userId, movieTitle, theaterName, scheduleTime, 
           GROUP_CONCAT(seatNumber ORDER BY seatNumber ASC) AS seatNumbersStr, bookingTime
    FROM reservation
    WHERE userId = #{userId}
    GROUP BY bookingTime, movieTitle, theaterName, scheduleTime, userId
    ORDER BY bookingTime DESC
</select>

<select id="isSeatBooked" parameterType="map" resultType="int">
	select count(*) from reservation
	where theaterName = #{theaterName}
    and scheduleTime = #{scheduleTime}
    and seatNumber = #{seatNumber}
</select>

<select id="getBookedSeats" parameterType="map" resultType="string">
    select seatNumber from reservation
    where theaterName = #{theaterName}
    and scheduleTime = #{scheduleTime}
</select>

</mapper>